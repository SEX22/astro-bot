<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Твой Гороскоп 2026</title>
    <!-- SDK Telegram для интеграции с мессенджером -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: #e2e8f0;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
        }

        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .zodiac-btn {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
        }

        .zodiac-btn.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .premium-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .tab-btn {
            position: relative;
            color: #94a3b8;
            transition: color 0.3s;
        }

        .tab-btn.active {
            color: #6366f1;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 4px;
            border-radius: 2px;
            background: #6366f1;
        }

        .loading-dots div {
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots .dot1 { animation-delay: -0.32s; }
        .loading-dots .dot2 { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .secret-reveal {
            animation: slideDown 0.5s ease forwards;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #errorPopup {
            background: rgba(239, 68, 68, 0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center">
    <div class="max-w-md w-full mx-auto">
        <!-- Сообщение об ошибке (если нет API ключа) -->
        <div id="errorPopup" class="hidden fixed top-4 left-4 right-4 z-[100] p-4 rounded-2xl text-white text-xs text-center shadow-xl">
            Похоже, API ключ не настроен. Бот работает в демо-режиме.
        </div>

        <!-- Верхняя панель управления энергией -->
        <div class="flex justify-between items-center mb-6 px-2">
            <div class="flex items-center space-x-3 bg-white/5 px-4 py-2 rounded-full border border-white/5">
                <span class="text-[10px] text-indigo-300 font-semibold uppercase tracking-widest">Энергия</span>
                <div class="flex space-x-1.5" id="energyBar">
                    <div class="w-2.5 h-2.5 bg-indigo-500 rounded-full shadow-[0_0_8px_rgba(99,102,241,0.6)]"></div>
                    <div class="w-2.5 h-2.5 bg-indigo-500 rounded-full shadow-[0_0_8px_rgba(99,102,241,0.6)]"></div>
                    <div class="w-2.5 h-2.5 bg-indigo-500 rounded-full shadow-[0_0_8px_rgba(99,102,241,0.6)]"></div>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="tgRefillEnergy()" class="w-10 h-10 flex items-center justify-center bg-indigo-500/10 border border-indigo-500/30 rounded-full text-indigo-400">
                    ✨
                </button>
            </div>
        </div>

        <div class="glass p-8 shadow-2xl">
            <header class="text-center mb-10">
                <h1 class="text-2xl font-semibold text-white mb-1 tracking-tight">Астро Поток</h1>
                <p id="userName" class="text-indigo-300/60 text-[10px] uppercase tracking-widest mb-2">Привет, путник</p>
                <div class="h-[1px] w-12 bg-indigo-500/30 mx-auto"></div>
            </header>

            <div class="flex justify-around mb-10 border-b border-white/5 pb-2">
                <button onclick="switchTab('forecast')" id="tab-forecast" class="tab-btn active text-sm font-medium">Прогноз</button>
                <button onclick="switchTab('compatibility')" id="tab-compatibility" class="tab-btn text-sm font-medium">Совместимость</button>
            </div>

            <!-- Секция Прогноза -->
            <div id="section-forecast" class="space-y-8">
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-gray-400 uppercase tracking-widest ml-1">Период</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setPeriod('today')" id="period-today" class="period-opt py-3 bg-white/10 border border-white/10 rounded-xl text-xs text-white transition-all">На день</button>
                        <button onclick="setPeriod('month')" id="period-month" class="period-opt py-3 bg-white/5 border border-white/10 rounded-xl text-xs text-gray-400 transition-all">На месяц</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <label class="block text-center text-[9px] font-bold text-gray-400 uppercase tracking-widest">Знак силы</label>
                    <div id="zodiacGrid" class="zodiac-grid"></div>
                </div>

                <button id="btnAction" class="w-full bg-white text-gray-900 font-bold py-4 rounded-2xl shadow-xl transform transition hover:brightness-110 active:scale-95 text-xs uppercase tracking-[0.2em]">
                    Спросить Вселенную
                </button>
            </div>

            <!-- Секция Совместимости -->
            <div id="section-compatibility" class="hidden space-y-8">
                <div class="space-y-6 text-center">
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase mb-4 tracking-widest">Твой знак</p>
                        <div id="compGrid1" class="zodiac-grid gap-2"></div>
                    </div>
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase mb-4 tracking-widest">Знак партнера</p>
                        <div id="compGrid2" class="zodiac-grid gap-2"></div>
                    </div>
                </div>
                <button id="btnActionComp" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl transform transition active:scale-95 text-xs uppercase tracking-[0.2em]">
                    Узнать совместимость
                </button>
            </div>

            <!-- Область результатов -->
            <div id="resultArea" class="mt-8 hidden">
                <div id="loadingIndicator" class="hidden flex flex-col items-center py-10">
                    <div class="loading-dots mb-4">
                        <div class="dot1"></div>
                        <div class="dot2"></div>
                        <div class="dot3"></div>
                    </div>
                    <p class="text-indigo-200/40 text-[10px] uppercase tracking-widest">Слушаем шепот звезд...</p>
                </div>

                <div id="contentDisplay" class="hidden space-y-6">
                    <div class="p-6 rounded-3xl bg-white/[0.03] border border-white/5 leading-relaxed">
                        <h3 id="resultHeader" class="text-xs font-bold text-indigo-300 mb-4 uppercase tracking-widest border-b border-white/5 pb-2"></h3>
                        <div id="resultBody" class="text-gray-300 text-sm font-light space-y-4"></div>
                        
                        <!-- Премиум-блок -->
                        <div id="premiumUpsell" class="mt-10 p-6 rounded-2xl bg-indigo-500/5 border border-indigo-500/10">
                            <div id="upsellContent">
                                <h4 class="text-xs font-semibold text-indigo-200 mb-2">Глубокое погружение</h4>
                                <p class="text-gray-400 text-[11px] mb-5 leading-relaxed">
                                    Хочешь узнать свой личный ключ удачи на этот период? (Числа, секретный совет)
                                </p>
                                <button onclick="showPayment('Открыть персональные ключи удачи', false)" class="premium-btn w-full py-4 rounded-xl text-[10px] uppercase tracking-widest shadow-lg">
                                    Посмотреть детали (10 ⭐)
                                </button>
                            </div>
                            <div id="premiumResult" class="hidden secret-reveal text-sm">
                                <h4 class="text-[10px] font-bold text-yellow-500 uppercase mb-3 tracking-widest">✨ Личный расчет:</h4>
                                <div id="premiumText" class="text-gray-200 space-y-3 font-light leading-relaxed italic border-l-2 border-yellow-500/30 pl-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно оплаты -->
    <div id="paymentModal" class="fixed inset-0 bg-[#0f0c29]/95 backdrop-blur-xl z-50 flex items-center justify-center hidden p-6">
        <div class="glass max-w-sm w-full p-10 text-center space-y-8">
            <div class="w-14 h-14 bg-indigo-500/20 rounded-2xl flex items-center justify-center mx-auto">
                <span class="text-2xl text-indigo-400">⭐</span>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-3 text-white">Звездный расчет</h4>
                <p id="paymentText" class="text-sm text-gray-400 font-light"></p>
            </div>
            <div class="space-y-4">
                <button id="confirmPayBtn" class="w-full bg-white text-gray-900 font-bold py-4 rounded-2xl hover:bg-gray-100 transition-all uppercase text-[10px] tracking-widest">
                    Поддержать за 10 Stars
                </button>
                <button onclick="closePayment()" class="w-full text-[10px] text-gray-500 uppercase font-bold tracking-widest pt-2">Закрыть</button>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        // ОБЯЗАТЕЛЬНО: Вставь свой API ключ от Gemini ниже
        const apiKey = ""; 
        
        let energy = 3;
        let currentTab = 'forecast';
        let selectedPeriod = 'today';
        let selectedSign = null;
        let compSign1 = null;
        let compSign2 = null;

        const signs = [
            { name: "Овен", icon: "♈" }, { name: "Телец", icon: "♉" },
            { name: "Близнецы", icon: "♊" }, { name: "Рак", icon: "♋" },
            { name: "Лев", icon: "♌" }, { name: "Дева", icon: "♍" },
            { name: "Весы", icon: "♎" }, { name: "Скорпион", icon: "♏" },
            { name: "Стрелец", icon: "♐" }, { name: "Козерог", icon: "♑" },
            { name: "Водолей", icon: "♒" }, { name: "Рыбы", icon: "♓" }
        ];

        const months = ["январь", "февраль", "март", "апрель", "май", "июнь", "июль", "август", "сентябрь", "октябрь", "ноябрь", "декабрь"];

        function init() {
            if (tg) {
                tg.expand();
                tg.ready();
                tg.setHeaderColor('#1a1a2e');
                tg.setBackgroundColor('#1a1a2e');
                
                const user = tg.initDataUnsafe?.user;
                if (user?.first_name) {
                    document.getElementById('userName').textContent = `Привет, ${user.first_name}`;
                }
            }
            renderGrids();
            updateEnergyUI();

            if (!apiKey) {
                const err = document.getElementById('errorPopup');
                err.classList.remove('hidden');
            }
        }

        function renderGrids() {
            const grid = document.getElementById('zodiacGrid');
            const cg1 = document.getElementById('compGrid1');
            const cg2 = document.getElementById('compGrid2');

            signs.forEach(s => {
                grid.appendChild(createZodiacBtn(s, (name) => {
                    selectedSign = name;
                    updateUISelection('zodiacGrid', name);
                }));
                cg1.appendChild(createZodiacBtn(s, (name) => {
                    compSign1 = name;
                    updateUISelection('compGrid1', name);
                }, true));
                cg2.appendChild(createZodiacBtn(s, (name) => {
                    compSign2 = name;
                    updateUISelection('compGrid2', name);
                }, true));
            });
        }

        function createZodiacBtn(sign, onClick, isSmall = false) {
            const div = document.createElement('div');
            div.className = `zodiac-btn rounded-2xl flex flex-col items-center justify-center ${isSmall ? 'p-2' : 'p-3'}`;
            div.dataset.name = sign.name;
            div.innerHTML = `<span class="${isSmall ? 'text-lg' : 'text-2xl'} mb-1 opacity-80">${sign.icon}</span><span class="text-[7px] uppercase font-semibold text-gray-500">${sign.name}</span>`;
            div.onclick = () => {
                onClick(sign.name);
                if (tg) tg.HapticFeedback.impactOccurred('light');
            };
            return div;
        }

        function updateUISelection(containerId, activeName) {
            document.querySelectorAll(`#${containerId} .zodiac-btn`).forEach(b => {
                b.classList.toggle('active', b.dataset.name === activeName);
            });
        }

        function setPeriod(p) {
            selectedPeriod = p;
            if (tg) tg.HapticFeedback.selectionChanged();
            document.querySelectorAll('.period-opt').forEach(opt => {
                const isActive = opt.id === `period-${p}`;
                opt.classList.toggle('bg-white/10', isActive);
                opt.classList.toggle('text-white', isActive);
                opt.classList.toggle('text-gray-400', !isActive);
                opt.classList.toggle('bg-white/5', !isActive);
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            if (tg) tg.HapticFeedback.impactOccurred('medium');
            document.getElementById('section-forecast').classList.toggle('hidden', tab !== 'forecast');
            document.getElementById('section-compatibility').classList.toggle('hidden', tab !== 'compatibility');
            document.getElementById('tab-forecast').classList.toggle('active', tab === 'forecast');
            document.getElementById('tab-compatibility').classList.toggle('active', tab === 'compatibility');
            document.getElementById('resultArea').classList.add('hidden');
        }

        function updateEnergyUI() {
            const dots = document.getElementById('energyBar').children;
            for (let i = 0; i < 3; i++) {
                dots[i].className = i < energy ? "w-2.5 h-2.5 bg-indigo-500 rounded-full shadow-[0_0_8px_rgba(99,102,241,0.6)]" : "w-2.5 h-2.5 bg-white/5 rounded-full";
            }
        }

        function tgRefillEnergy() {
            if (tg) tg.HapticFeedback.notificationOccurred('success');
            showPayment('Восполнить энергию звезд для новых вопросов', true);
        }

        function showPayment(text, isRefill) {
            document.getElementById('paymentText').textContent = text;
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('confirmPayBtn').onclick = isRefill ? processRefill : processPremiumReveal;
        }

        function closePayment() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function processRefill() {
            energy = 3;
            updateEnergyUI();
            closePayment();
        }

        async function processPremiumReveal() {
            if (!apiKey) {
                alert("Ошибка: API ключ не найден в коде.");
                return closePayment();
            }
            closePayment();
            const upsell = document.getElementById('upsellContent');
            const resBlock = document.getElementById('premiumResult');
            const resText = document.getElementById('premiumText');
            
            upsell.innerHTML = `<div class="flex items-center justify-center py-4"><div class="loading-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div></div>`;
            
            const prompt = `Дай секретный астро-ключ для знака ${selectedSign}. Включи: денежное число и краткий мистический совет. Будь краток.`;
            
            const text = await apiCall(prompt);
            upsell.classList.add('hidden');
            resBlock.classList.remove('hidden');
            resText.innerHTML = text ? text.replace(/\n/g, '<br>') : "Звезды молчат...";
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        async function handleAction() {
            if (energy <= 0) return tgRefillEnergy();
            
            if (currentTab === 'forecast' && !selectedSign) return;
            if (currentTab === 'compatibility' && (!compSign1 || !compSign2)) return;

            energy--;
            updateEnergyUI();
            if (tg) tg.HapticFeedback.impactOccurred('heavy');

            const resultArea = document.getElementById('resultArea');
            const loading = document.getElementById('loadingIndicator');
            const content = document.getElementById('contentDisplay');
            const body = document.getElementById('resultBody');
            const header = document.getElementById('resultHeader');

            resultArea.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            const currentMonthName = months[new Date().getMonth()];
            let prompt = "";
            let displayTitle = "";

            if (currentTab === 'forecast') {
                prompt = selectedPeriod === 'today' 
                    ? `Короткий прогноз для знака ${selectedSign} на сегодня. Тон: добрый мистик.`
                    : `Прогноз на ${currentMonthName} для знака ${selectedSign}.`;
                displayTitle = `${selectedSign} • ${selectedPeriod === 'today' ? 'Сегодня' : currentMonthName}`;
            } else {
                prompt = `Совместимость знаков ${compSign1} и ${compSign2}. Кратко.`;
                displayTitle = `Связь: ${compSign1} + ${compSign2}`;
            }

            header.textContent = displayTitle;
            const text = await apiCall(prompt);
            
            if (!text && !apiKey) {
                body.innerHTML = "<b>Демо-режим:</b> Чтобы получать реальные прогнозы, вставьте API ключ в переменную apiKey в коде.";
            } else {
                body.innerHTML = text ? text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>') : "Сбой в космосе. Попробуйте еще раз.";
            }
            
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function apiCall(prompt) {
            if (!apiKey) return null;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = "Ты — мудрый и современный астролог. Твой стиль — 'добрый бро-мистик'. Отвечай на русском языке.";
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { return null; }
        }

        document.getElementById('btnAction').onclick = handleAction;
        document.getElementById('btnActionComp').onclick = handleAction;
        init();
    </script>
</body>
</html>